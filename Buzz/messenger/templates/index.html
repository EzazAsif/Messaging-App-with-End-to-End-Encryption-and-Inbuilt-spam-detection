{% load static %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<h1 class="bold">Welcome {{ request.user.first_name }} {{ request.user.last_name }}</h1>

Message: <p style="font-weight: bold; font-size: 16px;" id="message">{{ message }}</p>
<br>

{% if pred %}
    Spam? : <p style="color: red; font-weight: bold;">{{ pred }}</p>
{% else %}
    Spam? : <p style="color: green; font-weight: bold;">{{ pred }}</p>
{% endif %}

<p style="font-weight: bold; font-size: 16px;">Encrypted message using Python:<br>{{ encrypted_message }}</p> 
<p style="font-weight: bold; font-size: 16px;">Decrypted message using Python:<br>{{ decrypted_message }}</p> 

<p style="font-weight: bold; font-size: 16px;" id="enc">Encrypted message using JS: <span id="jsEncryptedMessage"></span></p> 
<p style="font-weight: bold; font-size: 16px;" id="dec">Decrypted message using JS: <span id="jsDecryptedMessage"></span></p> 

<p style="font-weight: bold; font-size: 16px;" id="enc">Public Key: <br>{{request.user.public_key}} <span id="jsEncryptedMessage"></span></p> 
<p style="font-weight: bold; font-size: 16px;" id="dec">Private Key: <br>{{request.user.private_key}} <span id="jsDecryptedMessage"></span></p> 

<form method="POST" action="{% url 'test' %}">
    {% csrf_token %}
    <input name="message" type="text" required>
    <button type="submit" class="btn btn-success">Submit</button>
</form>

<a href="{% url 'logout' %}"><button type="button" class="btn btn-danger">Logout</button></a>



<script src="{% static 'encryptor.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>



<script>
    
     
    async function processEncryption(message, userId) {
        try {
            // Fetch Public Key from Django API
            const publicKeyBase64 = await fetchPublicKey(userId);
            // Fetch Private Key from Django API
            const privateKeyBase64 = await fetchPrivateKey(userId);
    
            // Import the public and private keys
            const publicKey = await importPublicKey(publicKeyBase64);
            const privateKey = await importPrivateKey(privateKeyBase64);
    
            // Generate an AES key (128-bit)
            const aesKey = crypto.getRandomValues(new Uint8Array(16)); // 128-bit AES key
    
            // Encrypt the message using AES
            const encryptedData = await aesEncrypt(message, aesKey);
    
            // Encrypt the AES key with the RSA public key
            const encryptedAESKey = await encryptAesKeyWithPublicKey(aesKey, userId);
    
            console.log("Encrypted AES Key:", encryptedAESKey);
            console.log("Encrypted Data:", encryptedData);
    
            // Decrypt the AES key using the RSA private key
            const decryptedAESKey = await decryptAesKeyWithPrivateKey(encryptedAESKey, userId);
    
            // Decrypt the message using the decrypted AES key
            const decryptedMessage = await aesDecrypt(encryptedData.ciphertext, decryptedAESKey, encryptedData.iv);
    
            console.log("Decrypted Message:", decryptedMessage);
        } catch (error) {
            console.error("Encryption process failed:", error);
        }
    }
    // Run the encryption process after the page loads
window.onload = async function() {
    const id = {{ request.user.id }}; // Make sure this is correctly rendered in your template
    const message = document.getElementById("message").innerText;
    await processEncryption(message, id);
};
    
</script>


